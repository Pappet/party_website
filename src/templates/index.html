<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ Party App</title>
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* ===== CSS VARIABLES SYSTEM ===== */
        :root {
            /* Color Palette - Light Mode */
            --color-primary: #667eea;
            --color-primary-dark: #5568d3;
            --color-primary-light: #7c92ff;
            --color-secondary: #764ba2;
            --color-accent: #ffd700;
            --color-success: #48bb78;
            --color-error: #f56565;
            --color-warning: #ed8936;
            --color-info: #4299e1;

            /* Neutral Colors */
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f8f9fa;
            --color-bg-tertiary: #e9ecef;
            --color-text-primary: #2d3748;
            --color-text-secondary: #6c757d;
            --color-text-tertiary: #999;
            --color-border: #ddd;
            --color-shadow: rgba(0, 0, 0, 0.2);

            /* Gradient */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            --gradient-warning: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);

            /* Spacing System (8px base) */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 40px;
            --space-2xl: 48px;

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-base: 300ms ease-in-out;
            --transition-slow: 500ms ease-in-out;

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px var(--color-shadow);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);

            /* Z-Index */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --color-bg-primary: #1a202c;
            --color-bg-secondary: #2d3748;
            --color-bg-tertiary: #4a5568;
            --color-text-primary: #f7fafc;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #cbd5e0;
            --color-border: #4a5568;
            --color-shadow: rgba(0, 0, 0, 0.5);
        }

        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            padding: var(--space-sm);
            color: var(--color-text-primary);
            transition: background var(--transition-base);
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* ===== CARD COMPONENT ===== */
        .card {
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-sm);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
            animation: slideIn var(--transition-base) ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
        }

        /* ===== TYPOGRAPHY ===== */
        h1 {
            color: var(--color-primary);
            text-align: center;
            margin-bottom: var(--space-xs);
            font-size: 2.5em;
            animation: fadeIn var(--transition-slow) ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h2 {
            color: var(--color-primary);
            margin-bottom: var(--space-sm);
            border-bottom: 3px solid var(--color-primary);
            padding-bottom: var(--space-xs);
        }

        h3 {
            color: var(--color-primary);
            margin-bottom: var(--space-sm);
        }

        .subtitle {
            text-align: center;
            color: white;
            margin-bottom: var(--space-lg);
            font-size: 1.2em;
        }

        /* ===== FORM ELEMENTS ===== */
        input[type="text"],
        textarea {
            width: 100%;
            padding: var(--space-sm);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 16px;
            margin-bottom: var(--space-sm);
            transition: all var(--transition-fast);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* ===== BUTTON SYSTEM ===== */
        button {
            position: relative;
            overflow: hidden;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-full);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            min-height: 48px;
        }

        /* Button Variants */
        .btn-primary,
        button:not(.btn-secondary):not(.btn-back):not(.vote-btn) {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover,
        button:not(.btn-secondary):not(.btn-back):not(.vote-btn):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 2px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-bg-tertiary);
            transform: translateY(-2px);
        }

        .btn-back,
        .back-btn {
            background: var(--color-text-secondary);
            color: white;
            margin-bottom: var(--space-sm);
        }

        .btn-back:hover,
        .back-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0) !important;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Loading State */
        button.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        button.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ripple Effect */
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:active::before {
            width: 300px;
            height: 300px;
        }

        .activity-btn {
            display: block;
            width: 100%;
            margin: var(--space-xs) 0;
            padding: var(--space-md);
            font-size: 18px;
            text-align: left;
            position: relative;
            transition: all var(--transition-base);
        }

        .activity-btn::after {
            content: '‚Üí';
            position: absolute;
            right: var(--space-md);
            font-size: 24px;
            transition: transform var(--transition-fast);
        }

        .activity-btn:hover::after {
            transform: translateX(5px);
        }

        .activity-btn .notification-badge {
            position: absolute;
            top: var(--space-xs);
            right: 60px;
            background: var(--color-error);
            color: white;
            border-radius: var(--radius-full);
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .vote-btn {
            padding: var(--space-xs) var(--space-sm);
            font-size: 14px;
            margin-top: 5px;
            min-height: auto;
        }

        /* ===== TOAST NOTIFICATION SYSTEM ===== */
        .toast-container {
            position: fixed;
            top: var(--space-md);
            right: var(--space-md);
            z-index: var(--z-tooltip);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            max-width: 400px;
        }

        .toast {
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            min-width: 300px;
            animation: slideInRight var(--transition-base) ease-out;
            border-left: 4px solid var(--color-info);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.toast-success {
            border-left-color: var(--color-success);
        }

        .toast.toast-error {
            border-left-color: var(--color-error);
        }

        .toast.toast-warning {
            border-left-color: var(--color-warning);
        }

        .toast.toast-info {
            border-left-color: var(--color-info);
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 20px;
            min-height: auto;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background: var(--color-bg-secondary);
            transform: none;
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-bg-tertiary);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            z-index: 10;
        }

        [data-theme="dark"] .loading-overlay {
            background: rgba(26, 32, 44, 0.8);
        }

        /* ===== DARK MODE TOGGLE ===== */
        .theme-toggle {
            position: fixed;
            top: var(--space-md);
            left: var(--space-md);
            z-index: var(--z-fixed);
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-full);
            width: 60px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 4px;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:hover {
            box-shadow: var(--shadow-lg);
        }

        .theme-toggle-slider {
            width: 24px;
            height: 24px;
            background: var(--gradient-primary);
            border-radius: 50%;
            transition: transform var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        [data-theme="dark"] .theme-toggle-slider {
            transform: translateX(28px);
        }

        /* ===== SOUND TOGGLE ===== */
        .sound-toggle {
            position: fixed;
            top: var(--space-md);
            left: 90px;
            z-index: var(--z-fixed);
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-full);
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-md);
            font-size: 20px;
        }

        .sound-toggle:hover {
            box-shadow: var(--shadow-lg);
            transform: scale(1.05);
        }

        .sound-toggle.muted {
            opacity: 0.5;
        }

        /* ===== CONNECTION STATUS INDICATOR ===== */
        .connection-status {
            position: fixed;
            top: var(--space-md);
            left: 150px;
            z-index: var(--z-fixed);
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-full);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 500;
        }

        .connection-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-error);
            animation: pulse 2s infinite;
        }

        .connection-status.connected .connection-status-dot {
            background: var(--color-success);
        }

        .connection-status.connecting .connection-status-dot {
            background: var(--color-warning);
        }

        /* ===== PAGE TRANSITIONS ===== */
        .page-transition-enter {
            animation: pageEnter var(--transition-base) ease-out;
        }

        .page-transition-exit {
            animation: pageExit var(--transition-fast) ease-in;
        }

        @keyframes pageEnter {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pageExit {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-20px);
            }
        }

        .hidden {
            display: none !important;
        }

        /* ===== USER COMPONENTS ===== */
        .user-greeting {
            background: var(--gradient-primary);
            color: white;
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-sm);
            font-size: 1.3em;
            box-shadow: var(--shadow-md);
        }

        .online-user-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            border: 2px solid var(--color-border);
            transition: all var(--transition-fast);
        }

        .online-user-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .online-status-dot {
            width: 8px;
            height: 8px;
            background: var(--color-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* ===== ENTRY & LIST COMPONENTS ===== */
        .entry {
            background: var(--color-bg-secondary);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            border-left: 4px solid var(--color-primary);
            transition: all var(--transition-fast);
        }

        .entry:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .entry-header {
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        /* ===== BINGO GRID ===== */
        .bingo-progress {
            margin: var(--space-md) 0;
        }

        .progress-bar-container {
            width: 100%;
            height: 24px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
            margin-bottom: var(--space-xs);
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            transition: width var(--transition-slow);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .progress-text {
            text-align: center;
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .bingo-item {
            background: var(--color-bg-secondary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 3px solid transparent;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bingo-item:hover {
            background: var(--color-bg-tertiary);
            transform: scale(1.05);
        }

        .bingo-item.completed {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--color-accent);
            animation: bingoComplete var(--transition-base) ease-out;
        }

        @keyframes bingoComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ===== STORY & COMPLIMENTS ===== */
        .story-text {
            background: var(--color-bg-secondary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md) 0;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .compliment-box {
            background: var(--gradient-warning);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            margin: var(--space-md) 0;
            font-size: 1.2em;
            text-align: center;
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.3);
        }

        /* ===== STATS & LEADERBOARD ===== */
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 2px solid var(--color-border);
            flex-wrap: wrap;
            gap: var(--space-sm);
        }

        .stat-item {
            text-align: center;
            min-width: 100px;
        }

        .stat-number {
            font-size: 2em;
            color: var(--color-primary);
            font-weight: bold;
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 0.9em;
        }

        .leaderboard-entry {
            background: var(--color-bg-secondary);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xs);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--color-primary);
            transition: all var(--transition-fast);
        }

        .leaderboard-entry:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .leaderboard-entry.current-user {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--color-accent);
            font-weight: bold;
        }

        .leaderboard-rank {
            font-size: 1.5em;
            color: var(--color-primary);
            margin-right: var(--space-sm);
            min-width: 30px;
        }

        .leaderboard-name {
            flex-grow: 1;
        }

        .leaderboard-score {
            font-size: 1.3em;
            color: var(--color-primary);
            font-weight: bold;
        }

        /* ===== CONFETTI CANVAS ===== */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: var(--z-modal);
        }

        /* ===== KEYBOARD SHORTCUTS HELP ===== */
        .shortcuts-hint {
            position: fixed;
            bottom: var(--space-md);
            right: var(--space-md);
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-xs) var(--space-sm);
            font-size: 12px;
            color: var(--color-text-secondary);
            box-shadow: var(--shadow-md);
            z-index: var(--z-fixed);
        }

        .shortcuts-hint kbd {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 600px) {
            :root {
                --space-sm: 12px;
                --space-md: 20px;
                --space-lg: 28px;
            }

            body {
                padding: var(--space-xs);
                padding-bottom: 80px;
            }

            h1 {
                font-size: 2em;
            }

            .card {
                padding: var(--space-md);
            }

            .theme-toggle,
            .sound-toggle {
                top: var(--space-xs);
                left: var(--space-xs);
            }

            .sound-toggle {
                left: 70px;
            }

            .connection-status {
                left: var(--space-xs);
                top: 70px;
                font-size: 12px;
                padding: 6px 12px;
            }

            .toast-container {
                top: var(--space-xs);
                right: var(--space-xs);
                left: var(--space-xs);
                max-width: none;
            }

            .toast {
                min-width: auto;
            }

            button {
                min-height: 52px;
                font-size: 18px;
            }

            .bingo-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .shortcuts-hint {
                display: none;
            }
        }

        /* ===== AUTO-SAVE INDICATOR ===== */
        .autosave-indicator {
            position: fixed;
            bottom: var(--space-md);
            left: var(--space-md);
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-full);
            padding: var(--space-xs) var(--space-sm);
            font-size: 12px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            box-shadow: var(--shadow-md);
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: var(--z-fixed);
        }

        .autosave-indicator.visible {
            opacity: 1;
        }

        .autosave-indicator.saving {
            color: var(--color-warning);
        }

        .autosave-indicator.saved {
            color: var(--color-success);
        }
    </style>
</head>

<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (Alt+D)">
        <div class="theme-toggle-slider">üåô</div>
    </div>

    <!-- Sound Toggle -->
    <div class="sound-toggle" onclick="toggleSound()" title="Toggle sound (Alt+S)">
        <span id="soundIcon">üîä</span>
    </div>

    <!-- Connection Status -->
    <div class="connection-status connecting" id="connectionStatus" title="WebSocket connection status">
        <div class="connection-status-dot"></div>
        <span id="connectionText">Verbinde...</span>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confetti Canvas -->
    <canvas id="confettiCanvas"></canvas>

    <!-- Auto-save Indicator -->
    <div class="autosave-indicator" id="autosaveIndicator">
        <span id="autosaveIcon">üíæ</span>
        <span id="autosaveText">Saved</span>
    </div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcuts-hint">
        Press <kbd>?</kbd> for shortcuts
    </div>

    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen">
            <h1>üéâ Willkommen zur Party! üéâ</h1>
            <p class="subtitle">Melde dich an und hab Spa√ü!</p>
            <div class="card">
                <h2>Anmeldung</h2>
                <input type="text" id="nameInput" placeholder="Dein Vorname" maxlength="20">
                <button onclick="login()">Los geht's! üöÄ</button>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="hidden">
            <div class="user-greeting">
                Hallo <span id="userName"></span>! üëã
            </div>

            <div class="card">
                <h2>Aktivit√§ten</h2>
                <button class="activity-btn" onclick="showActivity('truthLie')">
                    üé≠ Zwei Wahrheiten, eine L√ºge
                </button>
                <button class="activity-btn" onclick="showActivity('compliments')">
                    üíù Komplimente-Roulette
                    <span id="complimentBadge" class="notification-badge hidden"></span>
                </button>
                <button class="activity-btn" onclick="showActivity('bingo')">
                    üéØ Party-Bingo
                </button>
                <button class="activity-btn" onclick="showActivity('story')">
                    üìñ Gemeinsame Geschichte
                </button>
            </div>

            <div class="card">
                <h2>üë• Angemeldete Benutzer</h2>
                <div id="onlineUsers" style="margin-top: 15px;">
                    <p style="color: var(--color-text-tertiary);">L√§dt...</p>
                </div>
            </div>

            <div class="card">
                <h2>üëë Party-K√∂nig Rangliste</h2>
                <p style="margin-bottom: 15px; color: var(--color-text-secondary);">Die aktivsten Party-G√§ste basierend auf allen Aktivit√§ten!</p>
                <div id="globalLeaderboard">
                    <p style="color: var(--color-text-tertiary);">L√§dt...</p>
                </div>
            </div>
        </div>

        <!-- Truth or Lie Activity -->
        <div id="truthLie" class="hidden">
            <button class="back-btn" onclick="showMenu()">‚Üê Zur√ºck</button>
            <div class="card">
                <h2>üé≠ Zwei Wahrheiten, eine L√ºge</h2>
                <p style="margin-bottom: var(--space-md); color: var(--color-text-secondary);">Gib zwei wahre Aussagen und eine L√ºge √ºber dich ein. Andere m√ºssen raten!</p>

                <div id="truthLieInputSection">
                    <input type="text" id="truth1" placeholder="Erste Aussage (wahr)">
                    <input type="text" id="truth2" placeholder="Zweite Aussage (wahr)">
                    <input type="text" id="lie" placeholder="Dritte Aussage (gelogen)">
                    <button onclick="submitTruthLie()">Absenden</button>
                </div>

                <div id="truthLieUserEntry" style="display: none; margin-bottom: var(--space-md);"></div>

                <div id="truthLieEntries" style="margin-top: var(--space-lg);"></div>

                <div style="margin-top: var(--space-lg);">
                    <h3>üìä Deine Statistik</h3>
                    <div id="truthLiePersonalStats"></div>
                </div>
            </div>
        </div>

        <!-- Compliments Activity -->
        <div id="compliments" class="hidden">
            <button class="back-btn" onclick="showMenu()">‚Üê Zur√ºck</button>
            <div class="card">
                <h2>üíù Komplimente-Roulette</h2>
                <p style="margin-bottom: var(--space-md); color: var(--color-text-secondary);">Schreibe ein nettes Kompliment f√ºr einen zuf√§lligen Gast!</p>

                <div id="complimentTarget"></div>
                <textarea id="complimentText" placeholder="Dein Kompliment..."></textarea>
                <button onclick="submitCompliment()">Kompliment senden</button>

                <div style="margin-top: var(--space-lg);">
                    <h3>üìä Deine Statistik</h3>
                    <div id="complimentPersonalStats"></div>
                </div>

                <div id="receivedCompliments" style="margin-top: var(--space-lg);"></div>
            </div>
        </div>

        <!-- Bingo Activity -->
        <div id="bingo" class="hidden">
            <button class="back-btn" onclick="showMenu()">‚Üê Zur√ºck</button>
            <div class="card">
                <h2>üéØ Party-Bingo</h2>
                <p style="margin-bottom: var(--space-md); color: var(--color-text-secondary);">Finde G√§ste, auf die diese Dinge zutreffen. Klicke auf ein Feld, wenn du jemanden gefunden hast!</p>

                <!-- Progress Bar -->
                <div class="bingo-progress">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="bingoProgressBar">0%</div>
                    </div>
                    <div class="progress-text" id="bingoProgressText">0 / 12 abgeschlossen</div>
                </div>

                <div id="bingoGrid" class="bingo-grid"></div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="bingoScore">0</div>
                        <div class="stat-label">Abgeschlossen</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="bingoTotal">12</div>
                        <div class="stat-label">Gesamt</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Story Activity -->
        <div id="story" class="hidden">
            <button class="back-btn" onclick="showMenu()">‚Üê Zur√ºck</button>
            <div class="card">
                <h2>üìñ Gemeinsame Geschichte</h2>
                <p style="margin-bottom: var(--space-md); color: var(--color-text-secondary);">F√ºge einen Satz zur Geschichte hinzu. Sei kreativ!</p>

                <div class="story-text" id="storyText"></div>

                <textarea id="storySentence" placeholder="Dein Satz..."></textarea>
                <button onclick="addToStory()">Zur Geschichte hinzuf√ºgen</button>

                <div style="margin-top: var(--space-lg);">
                    <h3>üìä Deine Statistik</h3>
                    <div id="storyPersonalStats"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== STATE MANAGEMENT =====
        let csrfToken = null;
        let currentUser = '';
        let currentUserId = null;
        let currentTargetId = null;
        let soundEnabled = true;
        let lastReceivedComplimentsCount = 0;

        // WebSocket connection
        let socket = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;

        // Auto-save timers
        const autoSaveTimers = {};

        const bingoItems = [
            'war schon in √ºber 10 L√§ndern',
            'spielt ein Instrument',
            'kann jonglieren',
            'spricht mehr als 2 Sprachen',
            'hat ein ungew√∂hnliches Haustier',
            'war schon auf einem Konzert dieses Jahr',
            'kann gut kochen',
            'macht gerne Sport',
            'hat den gleichen Geburtsmonat wie du',
            'liest gerade ein Buch',
            'hat heute Geburtstag',
            'tr√§gt etwas Lila'
        ];

        // ===== TOAST NOTIFICATION SYSTEM =====
        function showToast(message, type = 'info', title = null) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            const titles = {
                success: title || 'Erfolg',
                error: title || 'Fehler',
                warning: title || 'Warnung',
                info: title || 'Info'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Play sound
            playSound(type);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideInRight 0.3s ease-in reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // ===== WEBSOCKET CONNECTION =====
        function initializeWebSocket() {
            // Initialize Socket.IO connection
            socket = io({
                transports: ['websocket', 'polling'],  // Try WebSocket first, fallback to polling
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000
            });

            // Connection events
            socket.on('connect', () => {
                console.log('‚úÖ WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus('connected');

                // Request initial data
                if (currentUserId) {
                    requestUpdate('online_users');
                    requestUpdate('leaderboard');
                }
            });

            socket.on('disconnect', (reason) => {
                console.log('‚ùå WebSocket disconnected:', reason);
                updateConnectionStatus('disconnected');
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                reconnectAttempts++;
                updateConnectionStatus('error');

                if (reconnectAttempts >= maxReconnectAttempts) {
                    showToast('Verbindung fehlgeschlagen. Lade Seite neu.', 'error');
                }
            });

            socket.on('reconnect', (attemptNumber) => {
                console.log('üîÑ Reconnected after', attemptNumber, 'attempts');
                showToast('Verbindung wiederhergestellt!', 'success');
                reconnectAttempts = 0;
            });

            socket.on('reconnecting', (attemptNumber) => {
                console.log('üîÑ Reconnecting attempt', attemptNumber);
                updateConnectionStatus('connecting');
            });

            // Custom events
            socket.on('connected', (data) => {
                console.log('Connected with SID:', data.sid);
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data.message);
                showToast(data.message, 'error');
            });

            // ===== ACTIVITY UPDATES =====

            // Online users and status updates
            socket.on('user_status', (data) => {
                console.log('User status update:', data);
                // Refresh online users list
                if (!document.getElementById('mainMenu').classList.contains('hidden')) {
                    loadOnlineUsers();
                }
            });

            socket.on('online_users_update', (data) => {
                const onlineUsersDiv = document.getElementById('onlineUsers');
                if (!onlineUsersDiv) return;

                if (data.users.length === 0) {
                    onlineUsersDiv.innerHTML = '<p style="color: var(--color-text-tertiary);">Momentan keine Benutzer online</p>';
                } else {
                    const userList = data.users.map(user =>
                        `<span class="online-user-badge">
                            <span class="online-status-dot"></span>
                            ${user.name}
                        </span>`
                    ).join('');
                    onlineUsersDiv.innerHTML = userList;
                }
            });

            socket.on('online_count', (data) => {
                // Update online count badge if exists
                console.log('Online users:', data.count);
            });

            // Leaderboard updates
            socket.on('leaderboard_update', (data) => {
                const leaderboard = document.getElementById('globalLeaderboard');
                if (!leaderboard) return;

                if (data.leaderboard.length === 0) {
                    leaderboard.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">Noch keine Aktivit√§ten. Spiele mit und sammle Punkte!</p>';
                    return;
                }

                leaderboard.innerHTML = '';
                data.leaderboard.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-entry';
                    if (entry.name === currentUser) {
                        div.classList.add('current-user');
                    }

                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;

                    div.innerHTML = `
                        <span class="leaderboard-rank">${medal}</span>
                        <span class="leaderboard-name">${entry.name}</span>
                        <span class="leaderboard-score">${entry.score} Punkte</span>
                    `;
                    leaderboard.appendChild(div);
                });
            });

            // Truth or Lie updates
            socket.on('truthlie_new_entry', (data) => {
                console.log('New truth/lie entry:', data);
                if (!document.getElementById('truthLie').classList.contains('hidden')) {
                    loadTruthLies();
                }
                showToast(`${data.user_name} hat neue Aussagen eingereicht!`, 'info');
            });

            socket.on('truthlie_update', (data) => {
                console.log('Truth/lie vote update:', data);
                if (!document.getElementById('truthLie').classList.contains('hidden')) {
                    loadTruthLies();
                }
                if (data.is_correct) {
                    showToast(`${data.user_name} hat richtig geraten!`, 'success');
                }
                // Refresh leaderboard
                loadGlobalLeaderboard();
            });

            // Compliment updates
            socket.on('new_compliment_sent', (data) => {
                console.log('Compliment sent:', data);
                showToast(`Kompliment an ${data.to_user} gesendet!`, 'success', 'üíù');
            });

            socket.on('new_compliment_received', (data) => {
                console.log('Compliment received:', data);
                showToast(`Neues Kompliment erhalten: "${data.text}"`, 'success', 'üíù');

                // Refresh compliments if on that page
                if (!document.getElementById('compliments').classList.contains('hidden')) {
                    loadReceivedCompliments();
                    loadComplimentStats();
                } else {
                    // Update badge
                    lastReceivedComplimentsCount++;
                    updateComplimentBadge(lastReceivedComplimentsCount);
                }

                // Refresh leaderboard
                loadGlobalLeaderboard();
            });

            // Bingo updates
            socket.on('bingo_update', (data) => {
                console.log('Bingo update:', data);
                showToast(`${data.user_name}: ${data.completed_count} Bingo-Felder abgeschlossen!`, 'info', 'üéØ');

                // Refresh leaderboard
                loadGlobalLeaderboard();
            });

            socket.on('bingo_complete', (data) => {
                console.log('Bingo complete:', data);
                showToast(`üéâ ${data.user_name} hat BINGO! üéâ`, 'success', 'BINGO!');
            });

            // Story updates
            socket.on('story_update', (data) => {
                console.log('Story update:', data);

                // Update story if on that page
                if (!document.getElementById('story').classList.contains('hidden')) {
                    const storyDiv = document.getElementById('storyText');
                    if (storyDiv) {
                        storyDiv.innerHTML = data.full_story.join(' ');
                    }
                    loadStoryStats();
                }

                showToast(`${data.user_name} hat zur Geschichte beigetragen!`, 'info', 'üìñ');

                // Refresh leaderboard
                loadGlobalLeaderboard();
            });

            // Confetti trigger (synchronized across all clients!)
            socket.on('trigger_confetti', () => {
                console.log('Triggering confetti!');
                triggerConfetti();
            });

            // Pong response
            socket.on('pong', () => {
                console.log('Pong received');
            });
        }

        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');

            if (!statusEl || !textEl) return;

            statusEl.className = 'connection-status ' + status;

            switch (status) {
                case 'connected':
                    textEl.textContent = 'Verbunden';
                    break;
                case 'connecting':
                    textEl.textContent = 'Verbinde...';
                    break;
                case 'disconnected':
                    textEl.textContent = 'Getrennt';
                    break;
                case 'error':
                    textEl.textContent = 'Fehler';
                    break;
                default:
                    textEl.textContent = status;
            }
        }

        function requestUpdate(type) {
            if (socket && socket.connected) {
                socket.emit('request_update', { type: type });
            }
        }

        // ===== SOUND SYSTEM =====
        function playSound(type) {
            if (!soundEnabled) return;

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Different frequencies for different notifications
            const frequencies = {
                success: 800,
                error: 400,
                warning: 600,
                info: 500
            };

            oscillator.frequency.value = frequencies[type] || 500;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const icon = document.getElementById('soundIcon');
            icon.textContent = soundEnabled ? 'üîä' : 'üîá';
            document.querySelector('.sound-toggle').classList.toggle('muted', !soundEnabled);

            showToast(
                soundEnabled ? 'Sounds aktiviert' : 'Sounds deaktiviert',
                'info',
                'Sound'
            );
        }

        // ===== DARK MODE SYSTEM =====
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            const slider = document.querySelector('.theme-toggle-slider');
            slider.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

            showToast(
                `${newTheme === 'dark' ? 'Dunkler' : 'Heller'} Modus aktiviert`,
                'info',
                'Design'
            );
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const slider = document.querySelector('.theme-toggle-slider');
            slider.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // ===== CONFETTI ANIMATION =====
        function triggerConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const confetti = [];
            const colors = ['#667eea', '#764ba2', '#ffd700', '#48bb78', '#f56565'];

            for (let i = 0; i < 100; i++) {
                confetti.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    r: Math.random() * 6 + 4,
                    d: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    tilt: Math.random() * 10 - 5,
                    tiltAngle: 0,
                    tiltAngleIncrement: Math.random() * 0.1 + 0.05
                });
            }

            function drawConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                confetti.forEach((piece, index) => {
                    ctx.beginPath();
                    ctx.fillStyle = piece.color;
                    ctx.arc(
                        piece.x + piece.tilt,
                        piece.y,
                        piece.r,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();

                    piece.tiltAngle += piece.tiltAngleIncrement;
                    piece.y += (Math.cos(piece.d) + 3 + piece.r / 2) / 2;
                    piece.tilt = Math.sin(piece.tiltAngle) * 15;

                    if (piece.y > canvas.height) {
                        confetti.splice(index, 1);
                    }
                });

                if (confetti.length > 0) {
                    requestAnimationFrame(drawConfetti);
                }
            }

            drawConfetti();
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            // Alt+D: Toggle dark mode
            if (e.altKey && e.key === 'd') {
                e.preventDefault();
                toggleTheme();
            }

            // Alt+S: Toggle sound
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                toggleSound();
            }

            // Escape: Go back to menu
            if (e.key === 'Escape') {
                const mainMenu = document.getElementById('mainMenu');
                if (mainMenu.classList.contains('hidden')) {
                    showMenu();
                }
            }

            // ?: Show shortcuts help
            if (e.key === '?' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                showToast(`
                    <strong>Tastenkombinationen:</strong><br>
                    Alt+D: Dark Mode<br>
                    Alt+S: Sound an/aus<br>
                    Esc: Zur√ºck zum Men√º<br>
                    1-4: Aktivit√§t w√§hlen (im Men√º)
                `, 'info', 'Shortcuts');
            }

            // Number keys 1-4: Quick activity selection (only in main menu)
            if (!document.getElementById('mainMenu').classList.contains('hidden')) {
                const activities = ['truthLie', 'compliments', 'bingo', 'story'];
                const num = parseInt(e.key);
                if (num >= 1 && num <= 4 && !e.target.matches('input, textarea')) {
                    showActivity(activities[num - 1]);
                }
            }
        });

        // ===== AUTO-SAVE SYSTEM =====
        function showAutoSaveIndicator(status = 'saved') {
            const indicator = document.getElementById('autosaveIndicator');
            const icon = document.getElementById('autosaveIcon');
            const text = document.getElementById('autosaveText');

            indicator.className = 'autosave-indicator visible ' + status;

            if (status === 'saving') {
                icon.textContent = '‚è≥';
                text.textContent = 'Speichert...';
            } else {
                icon.textContent = '‚úì';
                text.textContent = 'Gespeichert';
            }

            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        function setupAutoSave(inputId, saveCallback, delay = 1000) {
            const input = document.getElementById(inputId);
            if (!input) return;

            input.addEventListener('input', () => {
                clearTimeout(autoSaveTimers[inputId]);
                showAutoSaveIndicator('saving');

                autoSaveTimers[inputId] = setTimeout(() => {
                    const savedData = {
                        [inputId]: input.value,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('autosave_' + inputId, JSON.stringify(savedData));
                    showAutoSaveIndicator('saved');

                    if (saveCallback) {
                        saveCallback(input.value);
                    }
                }, delay);
            });

            // Load saved data
            const saved = localStorage.getItem('autosave_' + inputId);
            if (saved) {
                const data = JSON.parse(saved);
                // Only restore if less than 24 hours old
                if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                    input.value = data[inputId];
                }
            }
        }

        // ===== CSRF TOKEN =====
        async function loadCSRFToken() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                if (data.status === 'success') {
                    csrfToken = data.data.csrf_token;
                    console.log('‚úÖ CSRF Token loaded');
                }
            } catch (error) {
                console.error('Failed to load CSRF token:', error);
            }
        }

        // Load token when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadCSRFToken();
            loadTheme();
            initializeWebSocket();  // Initialize WebSocket connection
        });

        // ===== API CALL WITH LOADING STATE =====
        async function apiCall(url, options = {}, buttonElement = null) {
            try {
                // Show loading state on button
                if (buttonElement) {
                    buttonElement.classList.add('loading');
                    buttonElement.disabled = true;
                }

                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                // Add CSRF Token for POST/PUT/DELETE
                if (['POST', 'PUT', 'DELETE'].includes(options.method) && csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                const response = await fetch(url, {
                    headers,
                    ...options
                });

                const data = await response.json();

                if (!response.ok || data.status === 'error') {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                return data.data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            } finally {
                // Remove loading state
                if (buttonElement) {
                    buttonElement.classList.remove('loading');
                    buttonElement.disabled = false;
                }
            }
        }

        // ===== PAGE TRANSITIONS =====
        function hideElement(element) {
            element.classList.add('page-transition-exit');
            setTimeout(() => {
                element.classList.add('hidden');
                element.classList.remove('page-transition-exit');
            }, 150);
        }

        function showElement(element) {
            element.classList.remove('hidden');
            element.classList.add('page-transition-enter');
            setTimeout(() => {
                element.classList.remove('page-transition-enter');
            }, 300);
        }

        // ===== LOGIN =====
        async function login() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                showToast('Bitte gib deinen Namen ein!', 'warning');
                return;
            }

            const button = event.target;

            try {
                const data = await apiCall('/api/login', {
                    method: 'POST',
                    body: JSON.stringify({ name })
                }, button);

                currentUser = data.name;
                document.getElementById('userName').textContent = name;

                // Store user ID for WebSocket room management
                // We'll need to get this from the session, so let's fetch it
                const usersResponse = await apiCall('/api/users');
                const user = usersResponse.find(u => u.name === name);
                if (user) {
                    currentUserId = user.id;
                }

                hideElement(document.getElementById('loginScreen'));
                setTimeout(() => {
                    showElement(document.getElementById('mainMenu'));

                    // Request initial data via WebSocket
                    requestUpdate('online_users');
                    requestUpdate('leaderboard');

                    // Also load via API as fallback
                    loadOnlineUsers();
                    loadGlobalLeaderboard();

                    showToast(`Willkommen, ${name}!`, 'success');
                }, 150);
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        // Enter key to login
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('nameInput');
            if (nameInput) {
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });

        // ===== NAVIGATION =====
        function showMenu() {
            const mainMenu = document.getElementById('mainMenu');
            const activities = ['truthLie', 'compliments', 'bingo', 'story'];

            activities.forEach(activity => {
                hideElement(document.getElementById(activity));
            });

            setTimeout(() => {
                showElement(mainMenu);
                // Load data (WebSocket will handle real-time updates)
                loadOnlineUsers();
                loadGlobalLeaderboard();
            }, 150);
        }

        function showActivity(activity) {
            hideElement(document.getElementById('mainMenu'));

            setTimeout(() => {
                showElement(document.getElementById(activity));

                // Load initial data for the selected activity
                // WebSocket will handle real-time updates
                if (activity === 'truthLie') {
                    loadTruthLies();
                    setupAutoSave('truth1');
                    setupAutoSave('truth2');
                    setupAutoSave('lie');
                } else if (activity === 'compliments') {
                    loadComplimentTarget();
                    loadReceivedCompliments();
                    loadComplimentStats();
                    setupAutoSave('complimentText');
                } else if (activity === 'bingo') {
                    loadBingo();
                } else if (activity === 'story') {
                    loadStory();
                    setupAutoSave('storySentence');
                }
            }, 150);
        }

        // ===== TRUTH OR LIE =====
        function createVoteButton(entryId, statement) {
            const button = document.createElement('button');
            button.className = 'vote-btn';
            button.textContent = 'Das ist die L√ºge!';
            button.addEventListener('click', () => voteLie(entryId, statement, button));
            return button;
        }

        async function submitTruthLie() {
            const truth1 = document.getElementById('truth1').value.trim();
            const truth2 = document.getElementById('truth2').value.trim();
            const lie = document.getElementById('lie').value.trim();

            if (!truth1 || !truth2 || !lie) {
                showToast('Bitte f√ºlle alle Felder aus!', 'warning');
                return;
            }

            const button = event.target;

            try {
                await apiCall('/api/truthlie', {
                    method: 'POST',
                    body: JSON.stringify({ truth1, truth2, lie })
                }, button);

                document.getElementById('truth1').value = '';
                document.getElementById('truth2').value = '';
                document.getElementById('lie').value = '';

                // Clear auto-save
                localStorage.removeItem('autosave_truth1');
                localStorage.removeItem('autosave_truth2');
                localStorage.removeItem('autosave_lie');

                showToast('Deine Aussagen wurden gespeichert!', 'success');
                loadTruthLies();
            } catch (error) {
                // Error already shown
            }
        }

        async function loadTruthLies() {
            const data = await apiCall('/api/truthlie');

            const inputSection = document.getElementById('truthLieInputSection');
            const userEntrySection = document.getElementById('truthLieUserEntry');

            if (data.user_has_entry) {
                inputSection.style.display = 'none';
                userEntrySection.style.display = 'block';
                userEntrySection.innerHTML = '';

                const heading = document.createElement('h3');
                heading.textContent = 'Deine Aussagen';
                userEntrySection.appendChild(heading);

                const div = document.createElement('div');
                div.className = 'entry';
                div.style.background = 'rgba(102, 126, 234, 0.1)';

                data.user_entry.statements.forEach((stmt, i) => {
                    const stmtDiv = document.createElement('div');
                    stmtDiv.style.margin = '10px 0';
                    stmtDiv.textContent = `${i + 1}. ${stmt}`;
                    div.appendChild(stmtDiv);
                });

                userEntrySection.appendChild(div);
            } else {
                inputSection.style.display = 'block';
                userEntrySection.style.display = 'none';
            }

            const container = document.getElementById('truthLieEntries');
            container.innerHTML = '';

            const heading = document.createElement('h3');
            heading.textContent = 'Eintr√§ge der G√§ste';
            container.appendChild(heading);

            data.entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'entry-header';
                headerDiv.textContent = entry.user;
                entryDiv.appendChild(headerDiv);

                entry.statements.forEach((stmt, i) => {
                    const stmtDiv = document.createElement('div');
                    stmtDiv.style.margin = '10px 0';

                    const stmtText = document.createTextNode(`${i + 1}. ${stmt}`);
                    stmtDiv.appendChild(stmtText);

                    if (entry.votes[currentUser]) {
                        const userVote = entry.votes[currentUser];
                        // Normalize strings for comparison (trim whitespace)
                        const normalizedGuess = userVote.guess.trim();
                        const normalizedStmt = stmt.trim();

                        if (userVote.is_correct) {
                            // User guessed correctly
                            if (normalizedGuess === normalizedStmt) {
                                const correctText = document.createTextNode(` ‚úÖ Richtig! (${userVote.attempts} ${userVote.attempts === 1 ? 'Versuch' : 'Versuche'})`);
                                stmtDiv.appendChild(correctText);
                            }
                        } else {
                            // User guessed incorrectly
                            if (normalizedGuess === normalizedStmt) {
                                const wrongText = document.createTextNode(` ‚ùå Falsch! (${userVote.attempts} ${userVote.attempts === 1 ? 'Versuch' : 'Versuche'})`);
                                stmtDiv.appendChild(wrongText);
                            } else {
                                // Show vote button for statements not yet tried
                                stmtDiv.appendChild(document.createTextNode(' '));
                                stmtDiv.appendChild(createVoteButton(entry.id, stmt));
                            }
                        }
                    } else {
                        stmtDiv.appendChild(document.createTextNode(' '));
                        stmtDiv.appendChild(createVoteButton(entry.id, stmt));
                    }

                    entryDiv.appendChild(stmtDiv);
                });

                container.appendChild(entryDiv);
            });

            loadTruthLiePersonalStats();
        }

        async function voteLie(entryId, guess, buttonElement) {
            try {
                const result = await apiCall('/api/truthlie/vote', {
                    method: 'POST',
                    body: JSON.stringify({ entry_id: entryId, guess })
                }, buttonElement);

                if (result.correct) {
                    showToast(
                        `Du hast es in ${result.attempts} ${result.attempts === 1 ? 'Versuch' : 'Versuchen'} geschafft!`,
                        'success',
                        'Richtig!'
                    );
                    triggerConfetti();
                } else {
                    showToast(
                        `Versuch ${result.attempts}. Versuche es nochmal!`,
                        'error',
                        'Leider falsch!'
                    );
                }
                loadTruthLies();
            } catch (error) {
                // Error already shown
            }
        }

        async function loadTruthLiePersonalStats() {
            const scores = await apiCall('/api/truthlie/leaderboard');
            const statsDiv = document.getElementById('truthLiePersonalStats');
            statsDiv.innerHTML = '';

            const userStats = scores.find(entry => entry.name === currentUser);

            if (!userStats) {
                statsDiv.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">Du hast noch keine Eintr√§ge gel√∂st. Rate bei anderen mit!</p>';
                return;
            }

            statsDiv.innerHTML = `
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number">${userStats.solved_count}</div>
                        <div class="stat-label">Eintr√§ge gel√∂st</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${userStats.total_attempts}</div>
                        <div class="stat-label">${userStats.total_attempts === 1 ? 'Versuch' : 'Versuche'}</div>
                    </div>
                </div>
            `;
        }

        // ===== COMPLIMENTS =====
        async function loadComplimentTarget() {
            const targetData = await apiCall('/api/compliments/target');

            const targetDiv = document.getElementById('complimentTarget');
            if (targetData.target) {
                currentTargetId = targetData.target_id;
                targetDiv.innerHTML = `<div class="compliment-box">Schreibe ein Kompliment f√ºr: <strong>${targetData.target}</strong></div>`;
            } else {
                targetDiv.innerHTML = '<p style="color: var(--color-text-secondary);">Warte, bis mehr G√§ste da sind!</p>';
            }
        }

        async function loadReceivedCompliments() {
            const received = await apiCall('/api/compliments/received');

            // Check for new compliments
            if (received.length > lastReceivedComplimentsCount && lastReceivedComplimentsCount > 0) {
                const newCount = received.length - lastReceivedComplimentsCount;
                showToast(`Du hast ${newCount} neue${newCount > 1 ? '' : 's'} Kompliment${newCount > 1 ? 'e' : ''}!`, 'success', 'üíù');
                triggerConfetti();
            }
            lastReceivedComplimentsCount = received.length;

            // Update badge
            updateComplimentBadge(received.length);

            const receivedDiv = document.getElementById('receivedCompliments');
            if (received.length > 0) {
                receivedDiv.innerHTML = '<h3>Deine Komplimente ‚ù§Ô∏è</h3>';
                received.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'compliment-box';
                    div.textContent = c.text;
                    receivedDiv.appendChild(div);
                });
            } else {
                receivedDiv.innerHTML = '';
            }
        }

        function updateComplimentBadge(count) {
            const badge = document.getElementById('complimentBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function loadComplimentStats() {
            const stats = await apiCall('/api/compliments/stats');

            const statsDiv = document.getElementById('complimentPersonalStats');
            statsDiv.innerHTML = `
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number">${stats.sent}</div>
                        <div class="stat-label">Verschickt</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${stats.received}</div>
                        <div class="stat-label">Erhalten</div>
                    </div>
                </div>
            `;
        }

        async function loadCompliments() {
            await loadComplimentTarget();
            await loadReceivedCompliments();
            await loadComplimentStats();
        }

        async function submitCompliment() {
            const text = document.getElementById('complimentText').value.trim();
            if (!text || !currentTargetId) {
                showToast('Bitte schreibe ein Kompliment!', 'warning');
                return;
            }

            const button = event.target;

            try {
                await apiCall('/api/compliments', {
                    method: 'POST',
                    body: JSON.stringify({ to_user_id: currentTargetId, text })
                }, button);

                document.getElementById('complimentText').value = '';
                localStorage.removeItem('autosave_complimentText');

                showToast('Kompliment gesendet!', 'success', 'üíù');
                loadCompliments();
            } catch (error) {
                // Error already shown
            }
        }

        // ===== BINGO =====
        async function loadBingo() {
            const data = await apiCall('/api/bingo');

            const grid = document.getElementById('bingoGrid');
            grid.innerHTML = '';

            bingoItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bingo-item';
                if (data.completed.includes(index)) {
                    div.classList.add('completed');
                    div.innerHTML = `‚úì ${item}`;
                } else {
                    div.innerHTML = item;
                }
                div.onclick = () => toggleBingo(index);
                grid.appendChild(div);
            });

            const score = data.completed.length;
            const total = bingoItems.length;
            const percentage = Math.round((score / total) * 100);

            // Update progress bar
            const progressBar = document.getElementById('bingoProgressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            document.getElementById('bingoProgressText').textContent = `${score} / ${total} abgeschlossen`;
            document.getElementById('bingoScore').textContent = score;

            // Trigger confetti if bingo completed
            if (score === total && score > 0) {
                triggerConfetti();
            }
        }

        async function toggleBingo(index) {
            try {
                const result = await apiCall('/api/bingo/toggle', {
                    method: 'POST',
                    body: JSON.stringify({ item_index: index })
                });

                // Show appropriate toast
                const item = bingoItems[index];
                if (result.completed && result.completed.includes(index)) {
                    showToast(`"${item}" abgeschlossen!`, 'success', 'üéØ');
                }

                loadBingo();
            } catch (error) {
                // Error already shown
            }
        }

        // ===== STORY =====
        async function loadStory() {
            const sentences = await apiCall('/api/story');

            const storyDiv = document.getElementById('storyText');
            storyDiv.innerHTML = sentences.join(' ') || '<em style="color: var(--color-text-tertiary);">Die Geschichte beginnt hier... F√ºge den ersten Satz hinzu!</em>';

            await loadStoryStats();
        }

        async function loadStoryStats() {
            const stats = await apiCall('/api/story/stats');

            const statsDiv = document.getElementById('storyPersonalStats');
            statsDiv.innerHTML = `
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number">${stats.contributed}</div>
                        <div class="stat-label">Deine S√§tze</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">Gesamt</div>
                    </div>
                </div>
            `;
        }

        async function addToStory() {
            const sentence = document.getElementById('storySentence').value.trim();
            if (!sentence) {
                showToast('Bitte schreibe einen Satz!', 'warning');
                return;
            }

            const button = event.target;

            try {
                await apiCall('/api/story', {
                    method: 'POST',
                    body: JSON.stringify({ sentence })
                }, button);

                document.getElementById('storySentence').value = '';
                localStorage.removeItem('autosave_storySentence');

                showToast('Satz zur Geschichte hinzugef√ºgt!', 'success', 'üìñ');
                loadStory();
            } catch (error) {
                // Error already shown
            }
        }

        // ===== ONLINE USERS =====
        async function loadOnlineUsers() {
            try {
                const users = await apiCall('/api/users/online');

                const onlineUsersDiv = document.getElementById('onlineUsers');

                if (users.length === 0) {
                    onlineUsersDiv.innerHTML = '<p style="color: var(--color-text-tertiary);">Momentan keine Benutzer online</p>';
                } else {
                    const userList = users.map(user =>
                        `<span class="online-user-badge">
                            <span class="online-status-dot"></span>
                            ${user.name}
                        </span>`
                    ).join('');
                    onlineUsersDiv.innerHTML = userList;
                }
            } catch (error) {
                console.error('Error loading online users:', error);
            }
        }

        // ===== GLOBAL LEADERBOARD =====
        async function loadGlobalLeaderboard() {
            try {
                const scores = await apiCall('/api/leaderboard/global');

                const leaderboard = document.getElementById('globalLeaderboard');
                leaderboard.innerHTML = '';

                if (scores.length === 0) {
                    leaderboard.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">Noch keine Aktivit√§ten. Spiele mit und sammle Punkte!</p>';
                    return;
                }

                scores.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-entry';
                    if (entry.name === currentUser) {
                        div.classList.add('current-user');
                    }

                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;

                    div.innerHTML = `
                        <span class="leaderboard-rank">${medal}</span>
                        <span class="leaderboard-name">${entry.name}</span>
                        <span class="leaderboard-score">${entry.score} Punkte</span>
                    `;
                    leaderboard.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading global leaderboard:', error);
            }
        }

        // ===== NO MORE POLLING! =====
        // All updates now come via WebSocket events in real-time
        // This dramatically reduces CPU usage and network traffic
    </script>
</body>

</html>
